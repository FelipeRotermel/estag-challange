<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="Style.css">
    <title>PDV</title>
</head>
<body>
    <nav class="NavBar">
        <a class="Logo" href="index.html">Suite Store</a>
        <ul class="NavBarLinks">
            <li class="NavBarLink"><a href="Products.html">Products</a></li>
            <li class="NavBarLink"><a href="Categories.html">Categories</a></li>
            <li class="NavBarLink"><a href="History.html">History</a></li>
        </ul>
    </nav>
    <div class="Container">
        <div class="Column Transparent">
            <h2>Produtos</h2><br>
            <table class="ProductsTable">
                <thead class="ProductsTableItems">
                    <th class="Others">Code</th>
                    <th class="Product">Product</th>
                    <th class="Others">Price</th>
                    <th class="Others">Tax</th>
                    <th class="Others">Disp.</th>
                    <th class="Others">Category</th>
                    <th class="Others">Action</th>
                </thead>
                <tbody class="ProductsTableCategoryItems">
                    <!-- Renderização da lista -->
                </tbody>
            </table>
        </div>
        <div class="Column Line Transparent">
            <h2>Carrinho</h2><br>
            <table class="ProductsTable">
                <thead class="ProductsTableItems">
                    <th class="Others">Code</th>
                    <th class="Product">Product</th>
                    <th class="Others">Price</th>
                    <th class="Others">Amount</th>
                    <th class="Others">Category</th>
                    <th class="Others">Action</th>
                </thead>
                <tbody class="CartProductsItems">
                    <!-- Renderização da tabela -->
                </tbody>
            </table>
            <div class="Payment">
                <table>
                    <tr>
                        <th>Tax:</th>
                        <td class="Tax"></td>
                    </tr>
                    <tr>
                        <th>Total:</th>
                        <td class="Total"></td>
                    </tr>
                </table>
            </div>
        </div>
        <div class="ConfirmationPayment">
            <h1>Você tem certeza?</h1>
            <button class="table-cancel-btn" onclick="Cancel()">Não</button>
            <button class="table-finish-btn" onclick="BuyProductsInCart()">Sim</button>
            <div>
                <form action="" id="form">
                </form>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>

    <script>

        function BuyProductsInCart() {

            let carts = JSON.parse(localStorage.getItem('carts'));
            
            carts.forEach(cart => {
                fetch('http://localhost/routes/orders.php?action=get')
                    .then(response => response.json())
                    .then((data) => {
                        data.forEach(order => {
                            $.ajax({
                                url: 'http://localhost/routes/orders.php?action=postorder',
                                type: 'POST',
                                data: {
                                    productCode: JSON.stringify(parseInt(cart.id)),
                                    orderCode: JSON.stringify(order.max),
                                    amount: JSON.stringify(parseFloat(cart.amount)),
                                    price: JSON.stringify(parseFloat(cart.newUnitPrice)),
                                    tax: JSON.stringify(parseFloat(cart.tax)),
                                },
                                success: function (data) {
                                    console.log(data);
                                }
                            })

                            let amount = cart.amount;
                            let code = cart.id;
                            location.href=`http://localhost/routes/orders.php?action=updateOrder&amount=${amount}&code=${code}`;
                        });
                    });
            });

            setTimeout(function () {
                localStorage.removeItem('carts');
                location.href = "http://localhost/fronthtml/History.html";
            }, 200);

        }

        function Cancel(){
            window.location.href = "http://localhost/fronthtml/index.html";
        }

    </script>
    
</body>
</html>