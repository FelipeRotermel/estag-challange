<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="Style.css">
    <title>History</title>
</head>
<body>

    <nav class="NavBar">
        <a class="Logo" href="index.html">Suite Store</a>
        <ul class="NavBarLinks">
            <li class="NavBarLink"><a href="Products.html">Products</a></li>
            <li class="NavBarLink"><a href="Categories.html">Categories</a></li>
            <li class="NavBarLink"><a href="History.html">History</a></li>
        </ul>
    </nav>
    <div class="ContainerHistory">
        <h2>History</h2>
        <table class="HistoryTable">
            <thead class="HistoryTableInfo">
                <th>Code</th>
                <th>Tax</th>
                <th>Price</th>
                <th>Action</th>
            </thead>
            <tbody class="HistoryTableItems">
                <!-- Renderização da tabela -->
            </tbody>
        </table>
        <br>
    </div>
    <div id="myModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <table>
                <thead>
                    <th>Code</th>
                    <th>Product</th>
                    <th>Amount</th>
                    <th>Price</th>
                    <th>Tax</th>
                </thead>
                <tbody id="modal-tbody">

                </tbody>
            </table>
        </div>
    </div>

    <script>

        function renderHystory() {
            fetch('http://localhost/routes/orders.php?action=getall')
                .then(response => response.json())
                .then((data) => {
                    data.forEach(history => {
                        let tbody = document.querySelector(".HistoryTableItems");
                        let trow = document.createElement("tr");
                        trow.innerHTML =
                            `  
                            <td id="first-collun">${history.code}</td>
                            <td id="other-collun">${history.tax}</td>
                            <td id="other-collun">${history.total}</td>
                            <td id="other-collun"><button class="view-btn" onclick="viewProducts()">View</button></td>
                            `;
                        tbody.append(trow)
                    })
                })
        }

        function viewProducts() {
            document.getElementById('modal-tbody').innerText = "";
            var button = event.target.parentElement.parentElement;
            var code = button.children[0].innerText;
            var modal = document.getElementById("myModal");
            var span = document.getElementsByClassName("close")[0];
            window.onclick = function (event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            }
            span.onclick = function () {
                modal.style.display = "none";
            }
            modal.style.display = "block";
            fetch(`http://localhost/routes/orders.php?action=getdetail&code=${code}`)
                .then(response => response.json())
                .then((data) => {
                    data.forEach(product => {

                        /* Verifica se o nome contém caracteres especiais */
                        let specialChars = /[!@#$%^&*()_+={}\[\]:;<>,.?~]/;
                        if (specialChars.test(product.name)) {
                            product.name = 'Product with special characters'
                        }

                        var newAmount = product[3]
                        var tbody = document.getElementById('modal-tbody')
                        var tr = document.createElement('tr')
                        tr.innerHTML = `
                            <td>${product.code}</td>
                            <td>${product.name}</td>
                            <td>${newAmount}</td>
                            <td>${product.price}</td>
                            <td>${product.tax}</td>
                        `
                        tbody.append(tr)
                    })
                })
        }


        renderHystory()

    </script>
    
</body>
</html>