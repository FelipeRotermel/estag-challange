<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="Style.css">
    <title>PDV</title>
</head>
<body>
    <nav class="NavBar">
        <a class="Logo" href="index.html">Suite Store</a>
        <ul class="NavBarLinks">
            <li class="NavBarLink"><a href="Products.html">Products</a></li>
            <li class="NavBarLink"><a href="Categories.html">Categories</a></li>
            <li class="NavBarLink"><a href="History.html">History</a></li>
        </ul>
    </nav>
    <div class="Container">
        <div class="Column">
            <h2>Produtos</h2><br>
            <table class="ProductsTable">
                <thead class="ProductsTableItems">
                    <th class="Others">Code</th>
                    <th class="Product">Product</th>
                    <th class="Others">Price</th>
                    <th class="Others">Tax</th>
                    <th class="Others">Disp.</th>
                    <th class="Others">Category</th>
                    <th class="Others">Action</th>
                </thead>
                <tbody class="ProductsTableCategoryItems">
                    <!-- Renderização da lista -->
                </tbody>
            </table>
        </div>
        <div class="Column Line">
            <h2>Carrinho</h2><br>
            <table class="ProductsTable">
                <thead class="ProductsTableItems">
                    <th class="Others">Code</th>
                    <th class="Product">Product</th>
                    <th class="Others">Price</th>
                    <th class="Others">Amount</th>
                    <th class="Others">Category</th>
                    <th class="Others">Action</th>
                </thead>
                <tbody class="CartProductsItems">
                    <!-- Renderização da tabela -->
                </tbody>
            </table>
            <div class="Payment">
                <table>
                    <tr>
                        <th>Tax R$:</th>
                        <td class="Tax"></td>
                    </tr>
                    <tr>
                        <th>Total R$:</th>
                        <td class="Total"></td>
                    </tr>
                </table>
                <div class="PaymentButtons">
                    <button class="PaymentButtonCancel" onclick="CancelProducts()">Cancel</button>
                    <button class="PaymentButtonFinish" onclick="Finish();Execute()">Finish</button>
                </div>
            </div>
        </div>
    </div>

    <script>

        /* Adiciona o produto clicado ao carrinho */
        function addToCart(total) {
            let carts = JSON.parse(localStorage.getItem('carts')) || [];
            let row = this.event.target.parentElement.parentElement;

            let id = row.children[0].innerText;
            let name = row.children[1].innerText;
            let totalAmount = row.children[4].innerText;
            let unitPrice = (row.children[2].innerText).replace('R$ ', '');
            let category = row.children[5].innerText;
            let tax = row.children[3].innerText;

            let amount = 1;
            let percent = (parseFloat(tax) / 100);
            let newUnitPrice = (parseFloat(unitPrice) + (parseFloat(unitPrice) * percent)).toFixed(2);
            let totalTax = (parseFloat(unitPrice) * percent).toFixed(2);

            const cart = { id, name, newUnitPrice, category, amount, totalAmount, tax, totalTax };

            for (let i = 0; i < carts.length; i++) {
                if (carts[i].name == name) {
                    alert("Produto já está no carrinho!")
                    return;
                }
            }

            carts.push(cart);
            localStorage.setItem('carts', JSON.stringify(carts));

            renderCarts(cart);
            totalPrice();
            getTotalTax()
        }

        /* Função que cria a tabela do carrinho com as informações dos produtos clicados */
        function renderCarts(cart, total) {
            let tbody = document.querySelector(".CartProductsItems");
            let trow = document.createElement("tr");
            trow.innerHTML =`  
                <td>${cart.id}</td>
                <td>${cart.name}</td>
                <td>${cart.newUnitPrice}</td>
                <td class="number-input">
                    <button onclick="this.parentNode.querySelector('input[type=number]').stepDown(); totalPrice();getTotalTax();getCartsAmounts()">-</button>
                    <input class="quantity" min="1" max="${cart.totalAmount}" name="quantity" value="${cart.amount}" type="number" id="getCartAmount">
                    <button onclick="this.parentNode.querySelector('input[type=number]').stepUp();totalPrice();getTotalTax();getCartsAmounts()">+</button>
                </td>
                <td>${cart.category}</td>
                <td class="totalTaxQuantity" hidden>${cart.totalTax}</td>
                <td>
                    <button class="ProductsDeleteButton" onclick="removeCart()">Delete</button>
                </td>
            `;
            tbody.append(trow);
        }
        
        getCarts()

        /* Função que cria o card de produtos com as informações do produto */
        function renderProducts() {
            document.querySelector(".ProductsTableCategoryItems").innerText = "";
            let table = document.querySelector(".ProductsTableCategoryItems");
            fetch("http://localhost/routes/products.php?action=get")
                .then(response => response.json())
                .then((data) => {
                    data.forEach(product => {

                        /* Verifica se o nome contém caracteres especiais */
                        let specialChars = /[!@#$%^&*()_+={}\[\]:;<>,.?~]/;
                        if (specialChars.test(product.productname)) {
                            return;
                        }

                        if (parseInt(product.amount) > 0) {
                            let row = document.createElement("tr");
                            row.innerHTML = `
                                <td>${product.productcode}</td>
                                <td>${product.productname}</td>
                                <td>R$ ${product.price}</td>
                                <td>${product.tax}</td>
                                <td>${product.amount}</td>
                                <td>${product.categoryname}</td>
                                <td><button class="ProductsAddButton" onclick="addToCart()">Add</button></td>
                            `;
                            table.append(row);
                        }
                    });
                });
        }

        /* Função para limpar a compra */
        function Execute() {
            totalPrice()
            getTotalTax()
            let getTotal = (document.querySelector('.Total').innerText)
            let getTax = (document.querySelector('.Tax').innerText)
            location.href = `http://localhost/routes/orders.php?action=post&total=${getTotal}&tax=${getTax}`
        }

        /* Função para renderizar cada cart */
        function getCarts() {
            const carts = JSON.parse(localStorage.getItem('carts'));
            if (carts === null) {
                console.log("Lista vazia")
            } else {
                carts.forEach(cart => {
                    var specialCharsRegex = /[!@#$%^&*()_{}\[\]:;<>,.?~]/;
                    if (specialCharsRegex.test(cart.name)) {
                        return;
                    }
                    renderCarts(cart)
                });
            }
        }

        /* Função para calcular o valor de todos os items do carrinho */
        function totalPrice() {
            let carts = JSON.parse(localStorage.getItem('carts'));
            let quantities = document.querySelectorAll('.quantity');
            let total = 0;

            if (carts) {
                carts.forEach((cart, ItemCart) => {
                    console.log(ItemCart)
                    let numberPrice = parseFloat(cart.newUnitPrice);
                    let amount = parseInt(quantities[ItemCart].value);
                    total += numberPrice * amount;
                });
            }
            document.querySelector('.Total').innerText = parseFloat(total).toFixed(2);
        }

        totalPrice();

        function getTotalTax() {
            let carts = JSON.parse(localStorage.getItem('carts'));
            let quantities = document.querySelectorAll('.totalTaxQuantity');
            let totalTax = 0;

            if (carts) {
                carts.forEach((cart, ItemCart) => {
                    let amount = parseInt(carts[ItemCart].amount);
                    let tax = parseInt(quantities[ItemCart].innerText);
                    totalTax += tax * amount;
                });
            }
            document.querySelector('.Tax').innerText = parseInt(totalTax);
        }

        getTotalTax()

        /* Função para remover item da tabela e do localStorage */
        function removeCart() {
            let trow = this.event.target.parentElement.parentElement;
            let id = trow.children[0].innerText;
            let name = trow.children[1].innerText;
            let carts = JSON.parse(localStorage.getItem('carts'));
            let newCarts = carts.filter(cart => cart.id !== id && cart.name !== name);
            localStorage.setItem("carts", JSON.stringify(newCarts));
            trow.remove();
            totalPrice();
            getTotalTax()
        }

        /* Funcão para finalizar compra */
        function Finish() {
            let carts = JSON.parse(localStorage.getItem('carts'))

            if (carts && carts.length > 0) {
                document.querySelector('.CartProductsItems').innerText = ""
                getCarts()
                renderProducts()
                totalPrice()
                getTotalTax()
            } else {
                console.log("carrinho vazio")
            }
        }

        function getCartsAmounts() {
            let carts = JSON.parse(localStorage.getItem('carts'));
            let trow = this.event.target.parentElement.parentElement;
            let name = trow.children[1].innerText;
            let amount = trow.querySelector('.quantity').value;

            carts.forEach(cart => {
                if (cart.name == name) {
                    cart.amount = amount
                }
            })

            localStorage.setItem('carts', JSON.stringify(carts))
        }

        function CancelProducts() {
            localStorage.removeItem('carts')
            document.querySelector('.CartProductsItems').innerText = ""
            totalPrice()
            getTotalTax()
        }

        var total = (document.querySelector('.Total').innerText)



        renderProducts()

    </script>

</body>
</html>